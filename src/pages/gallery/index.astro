---
import Layout from '../../layouts/Layout.astro';
import PocketBase from 'pocketbase';
import SVGCard from '../../components/SVGCard.astro';
import { Collections } from '../../utils/pocketbase-types';

const pb = new PocketBase('http://127.0.0.1:8090');
const user = Astro.locals.user;

if (!user) {
  return Astro.redirect("/login");
}

const svgList = await pb
  .collection(Collections.Svgs)
  .getFullList({
    sort: "-created",
    filter: `user = "${user.id}"`,
  });
---

<Layout>
  <section class="max-w-7xl mx-auto px-6 py-10">
    <h1 class="text-4xl font-bold mb-10 text-center text-secondary">Galerie SVG</h1>

    {svgList.length === 0 ? (
      <p class="text-center text-lg text-error">Aucun SVG enregistr√© pour le moment.</p>
    ) : (
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-2 gap-10">
        {svgList.map((record) => (
          <SVGCard id={record.id} name={record.name} svg={record.svg} />
        ))}
      </div>
    )}
  </section>

  <script>
    // üóëÔ∏è Fonction pour supprimer un SVG via l'API
    async function deleteSVG(id) {
      if (!id) {
        alert("‚ùå ID du SVG manquant.");
        return;
      }

      if (!confirm("Confirmer la suppression de ce SVG ?")) return;

      try {
        const res = await fetch("/api/deleteSVG", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ id }),
        });

        if (!res.ok) throw new Error("Erreur lors de la suppression");

        alert("‚úÖ SVG supprim√© avec succ√®s !");
        location.reload();
      } catch (err) {
        console.error(err);
        alert("‚ùå √âchec de la suppression du SVG.");
      }
    }

    // üéØ Attache les √©v√©nements apr√®s chargement du DOM
    window.addEventListener("DOMContentLoaded", () => {
      const deleteButtons = document.querySelectorAll("[data-id]");

      deleteButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-id");
          deleteSVG(id);
        });
      });
    });
  </script>
</Layout>